`CPN` `智能家具` `DCU` `Socket`

# 面向智能建筑控制节点CPN的检测APP

## 关于背景

基于无中心计算网络的智能建筑控制系统是为了解决系统的“实用性”和“通用性”被
提出的。无中心控制系统是根据建筑的空间分布,为每个建筑空间单元和各类大型机电
设备都配置一个地位平等和计算能力平等的控制节点 CPN,每个 CPN 之间并没有管理
与被管理的关系,系统中的各类运算任务都是所有的 CPN 一起完成的。无中心计算节
点 CPN 可以被大量复制扩展,且所有 CPN 内都有一套标准的信息集,不存在信息无法
交互的问题。

可见,CPN 是系统能够灵活开放,便捷实用的基础,检测 CPN 是否能正常工作是
必不可少的,基于这个原因,提出了 CPN 检测软件设计与实现这个课题,帮助用户对
CPN 的变量设定和变量查询功能是否正常工作进行检测

## 无中心计算节点CPN

![CPN](/img/posts/CPN.png)

建筑从结构角度来看是由一个个空间构成的,而且建筑所要求的功能服务、各类终
端设备和机电设备在每个空间单元中通常是基本相同的,所以空间单元是可以复制扩展
的基本单元。在一个建筑空间单元内,不同的功能设备往往会相互作用而集成一些需要,
而相邻的建筑空间之间需要信息交互,比如人员流动、气流的流动等。

因此,无中心计算节点 CPN 被应需开发,一个具有标准化的信息集合(建筑空间
单元内部的信息和各类机电设备的信息),可复制生产和拓展的控制器硬件。一个 CPN
可以对应一个建筑空间单元或一个大型机电设备, CPN 之间根据建筑的空间分布结构即
插即用地连接形成一个网络,如上图所示,相互连接的 CPN 可以基于网络通信进行信
息交互,并且每个 CPN 节点内部都装置了一套操作系统 TOS,可以根据信息进行并行
计算,构成了一个无中心、所有节点平等、标椎化的无中心计算平台。如果将无中心智
能建筑平台看作成一台计算机,那么 TOS 就是这台计算机的操作系统,负责信息资源
的调度和任务管理,而每一个 CPN 就像 CPU 的一个内核,相邻 CPN 的通信连接即为
内核之间的数据总线,许多 CPN 就像多核 CPU 一样可以进行并行计算

### CPN节点结构

CPN 是构成无中心智能建筑平台的基本单元,CPN 与其对应负责的建筑空间单元
或机电设备的 DCU 连接,各 CPN 之间通过数据线连接形成通信网络。一个 CPN 结构
主要包含四个部分,分别为处理器、存储器、CPN 数据接口和 DCU 通信接口,如图
所示

![CPNNode](/img/posts/CPNNode.png)

CPN 中的处理器功能跟计算机 CPU 中的处理器类似,负责各种信息的处理、运行
计算,而且每个 CPN 上都装有相同的操作系统 TOS,所有节点的处理能力都是平等的,
各类计算和管理任务并不是只在某个 CPN 上独立完成,而是在每个参与的 CPN 上并行
完成,并通过 CPN 数据接口与相邻 CPN 进行信息交互形成并行计算模式。

CPN 的存储器用来存储记录所负责的建筑空间单元或机电设备的大量信息,每个
CPN 内部都会集成标准化的信息集,包括空间单元内的人员信息、照明设备信息,或机
电设备的出厂信息、物理参数和运行参数等。此外,CPN 也会存储计算过程中生成的临
时变量和计算结果,所有 CPN 的数据库共同组成了无中心平台的数据库。

CPN 的数据线接口允许 CPN 之间进行数据线连接,一个 CPN 总共有 6 个数据线接
口,最多同时与 6 个 CPN 进行连接,与之连接的 CPN 即为空间相邻的关系,根据位置
分为上下左右前后 6 个空间区域,同时这也隐含了建筑空间单元的位置信息。CPN 只与
相连接的 CPN 进行数据交互,通信时不需要寻址,以点对点的方式进行通信。

CPN 的 DCU 通信接口能够跟 CPN 所对应的空间单元的 DCU 或大型机电设备的
DCU 进行通信连接,从而根据标准化的信息集进行信息交互,因此可以获取和管控空
间单元和机电设备的各种信息。每个 CPN 只有一个 DCU 通信接口,但它支持多种通讯
协议,从而保证 CPN 可以与各类 DCU 产品兼容.

### CPN 节点的标准信息集

建筑空间单元和各类大型机电设备内都有大量运行信息,若每个控制系统对这些信
息都有自己的定义规则,那么不同系统之间就无法进行信息交换,系统的“通用性”和“实
用性”会显得不尽人意。在无中心计算节点 CPN 中制定了一套标准信息集,信息集最大
化包含了建筑空间单元和各类机电设备(水泵、冷机、冷却塔等)中的信息,并且对外
开放,希望成为行业标准.

每个 CPN 中都有一套相同的标准信息集,当 CPN 与某个 DCU 连接后,DCU 只要
发送信息通知 CPN 自己对应的是建筑空间单元还是冷机、水泵等机电设备,那么 CPN
就可以从标准信息集中加载该类的信息数据,从而与相连的 DCU 建立数据映射。基于
标准信息集,DCU 可以直接对 CPN 中的信息进行读写调用。

标准化的信息集,是无中心平台“通用性”的关键。针对 CPN 开发的管理软件和算
法可以直接复用,只要在 CPN 上安装了就可以正常运行,无需针对各个不同的平台而
进行二次开发工作,因为软件对信息的调用都遵循标准信息集提供的通用数据接口。

标准化的信息集,也是无中心平台“实用性”的基础。当建筑空间单元内部的某个信
息点被增加或删除,或者某个设备被更换时,CPN 内集成的标准信息集都不用修改,因
为标准信息集是最大化、不重不漏地集合了建筑空间单元的信息。大型机电设备发生了
改动,只要设备 DCU 的信息数据库仍然遵循标准化的信息集,就不会对 CPN 造成影响,
CPN 跟底层的 DCU 的数据映射关系不会改变。 CPN 只需要维护一套标准的信息数据库,
就可以跟各类建筑、各类机电设备兼容,避免了大量的现场组网配置工作,增强了系统
的实用性。

综上,标准信息集是无中心系统灵活开放、便捷实用的基石

### CPN 节点的数据交互接口

CPN 提供了数据交互接口使得用户设备可以与 CPN 进行连接,用户设备要接入
CPN 首先需要跟 CPN 进行物理连接和数据连接,然后才能跟 CPN 进行报文交互,CPN
数据交互接口与外设连接模型如图所示。用户设备跟 CPN 建立连接后,就可以对
CPN 内部的信息变量进行设定和查询。

![NodeData](/img/posts/NodeDate.png)

物理连接是外设通过物理手段与 CPN 建立连接,类似于 OSI 的物理层。总共有四
种连接方式:一是使用 LAN 接入,可以将 CPN 看作路由器,CPN 的 DHCP 功能会为
接入的设备分配 IP 地址。每个 CPN 只提供一个 LAN 接口,若用户有多于一个的设备
需要通过 LAN 方式接入的话,则需要增加交换机来实现端口的增加;二是使用 Wi-Fi
接入,可以将 CPN 当作一个 AP 来使用,在输入正确的密码后,CPN 的 DHCP 功能会
为接入的设备分配 IP 地址。因为 Wi-Fi 特性,设备往往会受限于带宽和干扰,通常情况
下,CPN 可以同时接入 10 个 Wi-Fi 设备。

数据连接是在物理连接之上创建的数据交互通道,类似于 OSI 的传输层。默认情况
下,CPN 会开启两种数据接入服务,UDP 接入服务和 TCP 接入服务。若用户设备使用
UDP 接入服务,接入的端口号为 5005,因为 UDP 协议是不可靠的数据传递,所以 CPN
会每间隔 10s 发送一个心跳帧给连接设备,用于设备识别连接状态。若使用 TCP 接入服
务,接入的端口号为 5004,因为 TCP 接入对资源消耗比较大,所以 CPN 最多允许同时
接入 8 个 TCP 设备,当接入设备对于 8 个的时候,最后一个接入的设备会替换掉最早
接入的设备。因为 TCP 是面向连接的、可靠的、基于字节流的传输层通信协议,所以
CPN 不会发送心跳帧来进行连接识别,但 CPN 会对连接设备进行连接超时监测,当超
过 90s 仍然未收到连接设备的 TCP 数据时,CPN 会主动与之断开连接。
报文交互是在数据连接之上依据交互协议规则进行的数据交互,类似于 OSI 的应用
层。CPN 上的操作系统有自己的报文交互协议规则,所有与 CPN 进行交互的设备都要
遵循这个规则。

## 功能需求

本软件是为了检测 CPN 节点是否能正常工作而设计开发的,其主要使用人员为想
对 CPN 进行检测的用户。在实际应用中,要求用户能够使用本软件模拟建筑空间单元
或机电设备的 DCU 对 CPN 中的信息变量进行设定和查询。所以经过分析,软件主要有
三个功能需要:一是能够生成与 CPN 进行通信的数据帧,包含变量设定帧和变量查询
帧;二是能够跟 CPN 进行数据交互连接,将数据帧发送给 CPN 和接收来自 CPN 的回
复帧;三是能够根据查询结果跟设定值进行匹配并给出检测结果。为了更好地对软件进
行全面、详细的功能需求分析,本节将对软件进行用例分析和数据流分析。

### 人机交互约束需求

用户使用软件时除了关心软件的功能是否齐全和完善,另一个关心的是人机交互是
否友好,不友好的人机交互会给用户带来不必要的困扰和错误操作,更严重的会导致软
件运行错误。除此之外,由于 CPN 内部操作系统对信息变量操作有一些规定跟约束,
所以为了防止用户做出一些有违操作破坏了 CPN 内部的规定和约束,影响 CPN 检测的
结果。以下是 CPN 检测软件的人机交互约束需求:

+ 当用户要从某个 DCU 跳转到另一个 DCU,比如用户当前处于模拟房间的
DCU,想要变成模拟冷机的 DCU ,此时若当前仍有变量值被修改但还未被设定,应该
提醒用户“有被修改的变量未设定,是否确定离开?如果离开则会自动撤销所有修改”。
这是因为当处于模拟哪个类型 DCU 时,就只对对应的信息集操作。

+ 当用户对变量进行查询操作时,若变量被设定的时间跟此时要查询的时间超
过变量生命周期,那么应该提醒用户“请对要查询的变量重新设定”。这是因为 CPN 内
部对变量都规定了一个生命周期 7 分钟,当超过这个生命周期,变量会被删除,导致无
法正确查询到变量值。

+ 提示用户的一些界面需求。当用户选择模拟哪个 DCU 后,对应的选项应被
标记,变得明显;当用户对某个变量修改后,对应变量也应该被标记显示;显示某类
DCU 的信息集时应该分组显示,比如运行状态信息、能耗信息和故障信息等,应该显
示每个分组的变量个数,若某个分组里有变量被选取,应该显示被选取个数。

## 总体设计

### 系统架构

![system](/img/posts/systemarch.png)

首先,选择智能手机作为 CPN 检测软件的运行设备,因为智能手机是一种便于携
带、使用简单和使用人群数量庞大的设备。在物理连接上,可以将 CPN 当作一个 AP (无
线访问接入点)来看,选择使用智能手机本身提供的 WiFi 功能跟 CPN 进行连接。之所
以选择 WiFi 作为物理连接的方式,是因为 WiFi 覆盖面积较大,在一定直径范围内连接
不受空间限制,此外 WiFi 较为稳定可靠,连接方式简单,只需输入密码即可。在数据
连接上,可以将 CPN 看作成服务器,而 CPN 检测软件为客户端,选择 TCP 协议作为服
务器跟客户端之间的传输协议。使用 TCP 协议可以确保 CPN 检测软件和 CPN 之间的数
据帧交互是有序的,这有利于开发者对 CPN 回复的结果帧进行分析的实现,比如客户
端给 CPN 先后发送了编号为 1 和编号为 2 的数据帧,那么 CPN 的返回结果肯定也是先
编号 1 的回复帧,然后是编号 2 的回复帧。在设计完物理连接和数据连接的方式后,只
要检测软件根据 CPN 内部操作系统规定的报文协议进行报文交互,就能成功进行信息
交互。

### 功能结构

![function](/img/posts/function.png)

数据库表创建模块的工作是创建三个数据库表,分别为变量信息表、匹配失败记录
表和检测正确率记录表,关于数据库会在第 4.6 章节进行详细阐述。其中匹配失败记录
表和检测正确率记录表在创建后并没有数据立即写入,这两个表只在数据帧分析模块中
可能会有数据写入。变量信息表被创建后,应该将 8 类 DCU 对应的信息集全部写入,
变量值全部使用默认值。这个模块只有在软件第一次被启动时会被执行,之后将不再被
使用。

数据帧生成模块的工作是生成用于跟 CPN 进行信息交互的数据帧,这个数据帧要
满足规定的帧格式。本模块分为变量设定帧生成模块和变量查询帧生成模块,变量设定
帧生成模块会根据用户提供的修改变量 ID 和修改值以及未修改变量 ID 和默认值按照一
定格式生成变量设定帧。变量查询帧会根据用户提供的变量 ID 或者全部变量 ID 生成变
量查询帧。

数据帧发送/接收模块的工作是跟 CPN 建立通信连接并将数据帧发送给 CPN 以及接
收来自 CPN 的数据帧。本模块是使用基于 TCP 协议的 Socket 编程实现跟 CPN 建立通
信的,所以 CPN 检测软件向 CPN 发送数据和接收数据都是基于字节流形式的,应该将
数据帧以单字节数组存储。

数据帧分析模块的工作是对来自 CPN 的结果帧进行分析,本模块分为设定结果帧
分析模块和查询结果帧分析模块。设定结果帧分析模块主要是分析来自 CPN 的设定结
果帧,从而判定 CPN 检测软件对 CPN 内部的变量设定是否执行成功,并通知用户。查
询结果帧分析模块是分析来自 CPN 的查询结果帧并获取变量的查询值,然后跟从变量
信息表中获取到的对应的变量设定值进行匹配。分为查询值匹配模块和检测正确率计算
模块,其区别在于查询值匹配模块只对一个变量进行查询值和设定值匹配,而检测正确
率计算模块则是对全部变量进行查询值和设定值匹配,并计算出正确率。数据帧分析模
块还有一个额外的工作是将匹配失败记录写入匹配失败记录表中和将检测正确率写入
检测正确率记录表中。

记录表查询模块较为简单,工作为将匹配失败记录表和检测正确率记录表以列表的
形式显示给用户。

## 界面设计

### 变量设定界面

![check](/img/posts/uicheck.png)

最顶部为导航栏,用户可以点击对应的按钮进行变量设定界面和变量查询界面的切
换,还可以通过滑动实现页面切换。导航栏的变量设定和变量查询为两个 Button 控件,
并使用 Android 中的 ViewPager+Fragment 的方案实现两个页面的管理和切换。
导航栏下方左边是 DCU 类型菜单,用户可以点击对应的选项来选择要模拟的 DCU
类型,目前有 8 个选项对应于 8 种 DCU 类型。DCU 类型菜单使用 Android 的 ListView
控件来实现,并为控件添加了一个适配器来实现列表的 管理,列表的每列有一个
TextView 控件用来显示选项名称。ListView 控件上方是一个 TextView 控件,只是用来
显示“类型菜单”,没有点击事件。

右边设计为一个折叠列表用于显示 DCU 对应的标准信息集,并将信息集进行了分
组 , 用 户 可 以 点 击 列 表 的 某 行 来 输 入 变 量 设 定 值 。 折 叠 列 表 使 用 Android 的
ExpandableListView 控件来实现,折叠列表的每组列上有三个 TextView 控件,第一个
TextView 控件用来显示组名,第二个 TextView 控件用来显示小组中变量已经被设定过
的数量,第三个 TextView 控件用来显示小组中全部变量个数。折叠列表的每组内的每
列上有一个 TextView 控件用来显示变量名称,还有一个 ImageButton 控件用来显示变量
是否已经被修改值。

当用户点击折叠列表的某个子列时,使用 Android 的 AlertDialog 类显示弹框,弹框
内有一个 EditText 控件用来让用户输入设定值。

界面上还有撤销和设定这两个 Button 按钮,撤销按钮是将用户输入变量值的操作全
部撤销;设定按钮是最重要的一个操作之一,是软件提供给用户唯一用于对 CPN 内部
的变量进行设定的入口。

### 变量查询界面设计

![uisearch](/img/posts/uisearch.png)

界面跟变量设定界面非常相似,同样有顶部导航栏、DCU 类型菜单和显示标准信
息集的折叠列表,这些界面的设计原理跟变量设定界面一样,不再阐述。但是,用户点
击可折叠列表的某行时不再是弹出变量值设定弹框,而是变量查询值弹框,弹框上有三
个 TextView 分别用来显示变量设定值、变量查询值和检测结果,这是软件提供给用户
从 CPN 内部查询变量值的一个入口。

界面上有一个整体检测按钮,整体检测按钮是另外一个软件提供给用户从 CPN 内
部查询所有变量值的入口,使用 Button 控件来实现,当用户点击此按钮时,同样使用
AlertDialog 类来实现检测正确率弹框的显示。

界面上还有一个记录查询按钮,提供给用户查看记录数据表的入口。按钮也是使用
Button 控件,当用户点击时,使用 Android 的 ListView 控件来显示数据表。

### 数据帧生成模块设计

数据帧的生成依赖于标准信息集。组成建筑的基本单元包括空间单元以及各类机电
设备,每一种基本单元都有一组标准化的信息集,用来描述运行参数、能耗、故障报警
等。CPN 节点要求数据帧均为 Hex 格式,然而每个变量在实际中都有其物理意义,所
以必须明确每一个信息变量的数据类型,方便于在软件中对不同的数据类型跟 Hex 格式
的转换。

数据帧是 CPN 检测软件和 CPN 进行通信的重要媒介,只有通过数据帧软件才能对
CPN 内部的变量进行设定和查询。CPN 对与之交互的数据帧有严格的格式要求,违反
格式要求的数据帧将不被 CPN 接收处理。数据帧分为 App 触发帧、数据结果帧、确认
帧和心跳帧四种类型,数据帧生成模块只跟 App 触发帧有关,又分为变量设定帧和变量
查询帧。

本节将对标准信息集中不同的数据类型在软件中如何定义进行设计,对变量设定帧
和变量查询帧的格式进行分析以便于数据帧的设计,对数据帧生成模块的具体程序流程
进行设计。

#### 信息点数据类型定义的设计

![ui3](/img/posts/uipar.png)

![ui3](/img/posts/uipar2.png)

房间单元的信息包括环境参数信息、能耗信息、插座信息、照明设备信息、电动窗
信息、电动遮阳信息和门信息等,机电设备的信息包括运行状态信息、能耗信息、故障
报警信息等。这些信息在 CPN 中都有自己的变量 ID,在现实中都有实际的物理意义,
每个变量都有变量 ID 、变量名、数据类型和数据单位这些特征。本节将对所有信息点
的数据类型在软件中的定义进行设计,说明不同数据类型如何跟 Hex 格式进行转换。

信息点的数据类型总共分为 10 种类型,在软件中我们使用一个整形变量 type 来定
义这 10 种类型,依次为 1 到 10。信息集中 int 数据类型和 float 数据类型占大部分,对
于 int 类型的变量本身就可以存储 16 进制数,对于 float 数据类型转换为 16 进制数只需
将 float 转换为 int 类型即可。除了这两类数据类型外,其余数据类型都不是基本的数据
类型,且取值都是有限的,需要将这些数据类型可能取到的变量值跟 16 进制数作一个
映射。

#### 数据帧生成流程

数据帧生成模块主要是根据数据帧类型和变量信息生成对应的变量设定帧和变量
查询帧,其中变量设定帧又分为 CPN 类型变量设定帧和物理参数变量设定帧。由于 CPN
是根据 DCU 传递过来的类型而加载对应的标准信息集,所以 CPN 类型变量设定帧是用
于在对物理参数变量设定或查询前先对 CPN 的类型进行设定。如图 4.5 所示是数据帧生
成模块的流程设计。

![dataflow](/img/posts/dataflow.png)

### 数据帧发送/接收模块设计

数据帧发送/接收模块的主要功能是实现与 CPN 进行报文交互。前文提到,CPN 与
外设的数据连接分为 UDP 接入和 TCP 接入两种,考虑到 TCP 协议是面向连接的,可靠
性强的传输协议,这使得软件与 CPN 之间的数据帧交互是有序的,方便软件对 CPN 返
回的数据结果帧的分析,所以本软件与 CPN 的通讯方式采用了基于 TCP 协议的 Socket
通信。同时,Android 对面向连接的 Socket 通信有很好的类支持,包括了 Socket 类和
ServerSocket 类,这使得软件与 CPN 之间的 Socket 通信的实现变得简单了。

此外,CPN 内部的操作系统有自己的报文交互协议规则,包括数据规则、报文确认
及重发规则等,所有与 CPN 进行报文交互的设备都要遵循此规则。所以在设计数据帧
发送/接收模块的时候也要遵从这些协议规则,否则将导致数据帧交互失败。

本节将对 CPN 的报文交互协议规则进行阐述,以及对数据帧的发送与接收流程作
具体的设计。

#### CPN 报文交互协议规则

报文交互协议规则是对报文交互过程的一些限制,在设计数据帧发送/接收模块前应
该先了解这些规则。规则主要分为 4 个部分,分为数据规则、报文确认及重发规则、重
复及错误报文规则和连接超时规则,接下来依次对这些规则进行说明。

数据规则规定所有发送给 CPN 的数据帧都要以字节流的方式,因为数据帧都是以
16 进制格式生成的,所以按两个 16 进制数为一个字节。由于 java 的 byte 数据类型为有
符号数,所以数据帧生成模块生成的数据帧是以 int 型存储的,在数据帧发送前需要把
数据帧转换为以 byte 数组的形式存储。对应的,在接收 CPN 返回的数据帧后需要把以
byte 数组存储的数据帧转换为 int 类型。

报文确认及重发规则规定 App 触发帧以及数据结果帧都需要确认帧进行确认,确认
帧本身不需要被确认,当数据帧发送后在 200ms 内没有收到确认帧,则发送方会进行重
发,重发次数为 3 次。因此,CPN 在返回结果帧之前会先发送一个对 App 触发帧的确
认帧。但是,为了实现简单,本软件在接收到 CPN 返回的数据结果帧后,并不会给 CPN
发送确认帧,这将导致 CPN 会重复发送数据结果帧,所以需要在数据帧分析模块中对
重复报文进行筛选过滤。

重复及错误报文规则规定如果两个报文的帧类型和帧名称都相同,且在 32 条有效
历史报文之内,那么这两个报文为重复报文,重复报文不会被 CPN 处理应答。另外如
果报文的帧类型为非法帧类型或者校验码错误,则此报文将会被 CPN 直接丢弃,不做
处理。所以应该确保发送给 CPN 的报文不是重复报文或错误报文,否则将接收不到结
果帧。

连接超时规则规定对于与 CPN 以 TCP 协议方式进行连接的设备,当 CPN 在 90s
之内没有收到来自连接设备的数据帧,则 CPN 会主动与该设备断开连接。所以在实现
Socket 通信时应该考虑是主动断开与 CPN 的连接,还是在没有数据帧发送的期间,每
间隔一段时间发送一个无意义的心跳包,从而保证连接不断开。

#### 数据帧发送/接收流程

![process](/img/posts/process.png)

### 数据帧分析模块设计

数据帧分析模块的主要功能为对 CPN 返回的数据结果帧进行分析,其中数据结果
帧分为对应变量设定帧的执行结果帧和对应变量查询帧的查询结果帧,通过对执行结果
帧的分析可以获取变量设定帧是否被成功执行的信息,对查询结果帧的分析可以获取
CPN 中被查询变量的值,并且通过查询值与设定值进行数值匹配从而得出 CPN 是否能
正常工作的结论。

![ans](/img/posts/ans.png)

